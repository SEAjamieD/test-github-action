trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # docker image namespace
  imageNamespace: my-docker-id
  # docker image name
  imageName: my-image-name


steps:
- task: DockerInstaller@0
  inputs:
    dockerVersion: '17.09.0-ce'

- script: |
    docker build -t $(imageNamespace)/$(imageName) .
displayName: 'Build Docker image'

- script: |
    curl -sSL https://mondoo.io/download.sh | bash 
    echo ${MONDOO_CLIENT_ACCOUNT} | base64 -d > mondoo.json
    ./mondoo scan -t docker://$(imageNamespace)/$(imageName) --config mondoo.json 
displayName: 'Run mondoo vulnerability scan'
  env:
    MONDOO_CLIENT_ACCOUNT: $(MONDOO_CLIENT_ACCOUNT)

- script: |
    docker build -t $(imageNamespace)/$(imageName) .
    docker login -u $(dockerUser) -p $(pswd)
    docker push $(imageNamespace)/$(imageName)
env:
    pswd: $(dockerPassword)
